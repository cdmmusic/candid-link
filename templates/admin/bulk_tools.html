{% extends "admin/layout.html" %}

{% block title %}ì¼ê´„ ì‘ì—…{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ”§ ì¼ê´„ ì‘ì—… ë„êµ¬</h1>
    <p class="page-subtitle">Excel import, ì¤‘ë³µ ì œê±° ë“± ëŒ€ëŸ‰ ë°ì´í„° ì‘ì—…</p>
</div>

<!-- Excel Import -->
<div class="card" style="margin-bottom: 20px;">
    <div class="card-header">
        <h2 class="card-title">ğŸ“¥ Excel íŒŒì¼ Import</h2>
    </div>
    <div>
        <p style="color: #6c757d; margin-bottom: 15px;">
            Excel íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ì•¨ë²” ì •ë³´ë¥¼ ì¼ê´„ ë“±ë¡í•©ë‹ˆë‹¤. í•„ìˆ˜ ì»¬ëŸ¼: <code>artist_ko</code>, <code>album_ko</code>
        </p>

        <div style="display: flex; gap: 15px; align-items: center;">
            <input type="file" id="excel-file" accept=".xlsx,.xls"
                   style="flex: 1; padding: 10px; border: 1px solid #dee2e6; border-radius: 8px;">
            <button onclick="importExcel()" class="btn-import">
                â¬†ï¸ ì—…ë¡œë“œ ë° Import
            </button>
        </div>

        <div id="import-result" style="margin-top: 15px;"></div>
    </div>
</div>

<!-- Clean Duplicates -->
<div class="card" style="margin-bottom: 20px;">
    <div class="card-header">
        <h2 class="card-title">ğŸ§¹ ì¤‘ë³µ ë°ì´í„° ì •ë¦¬</h2>
    </div>
    <div>
        <p style="color: #6c757d; margin-bottom: 15px;">
            ë™ì¼í•œ ì•¨ë²”ì— ëŒ€í•´ ì¤‘ë³µëœ í”Œë«í¼ ë§í¬ë¥¼ ì°¾ì•„ì„œ ì œê±°í•©ë‹ˆë‹¤.
        </p>

        <button onclick="cleanDuplicates()" class="btn-clean">
            ğŸ—‘ï¸ ì¤‘ë³µ ë°ì´í„° ì •ë¦¬
        </button>

        <div id="clean-result" style="margin-top: 15px;"></div>
    </div>
</div>

<!-- Database Stats -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ í†µê³„</h2>
    </div>
    <div id="db-stats">
        <div style="text-align: center; padding: 40px; color: #6c757d;">í†µê³„ ë¡œë”© ì¤‘...</div>
    </div>
</div>

<style>
    .btn-import {
        padding: 12px 24px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
        white-space: nowrap;
    }

    .btn-import:hover {
        background: #0056b3;
    }

    .btn-clean {
        padding: 12px 24px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }

    .btn-clean:hover {
        background: #c82333;
    }

    .result-box {
        padding: 14px 18px;
        border-radius: 8px;
        font-size: 14px;
    }

    .result-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .result-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .result-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }

    code {
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
    }

    .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .stat-item {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .stat-item-label {
        font-size: 13px;
        color: #6c757d;
        margin-bottom: 6px;
    }

    .stat-item-value {
        font-size: 24px;
        font-weight: 700;
        color: #007bff;
    }
</style>

<script>
    // Excel Import
    async function importExcel() {
        const fileInput = document.getElementById('excel-file');
        const file = fileInput.files[0];

        if (!file) {
            showResult('import-result', 'íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        showResult('import-result', 'ì—…ë¡œë“œ ì¤‘...', 'info');

        try {
            const response = await fetch('/admin/api/bulk/import-excel', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showResult('import-result', `âœ… ${data.message}`, 'success');
                fileInput.value = '';
                setTimeout(() => loadDbStats(), 1000);
            } else {
                showResult('import-result', `âŒ ${data.error}`, 'error');
            }
        } catch (error) {
            showResult('import-result', `âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    // Clean Duplicates
    async function cleanDuplicates() {
        if (!confirm('ì¤‘ë³µ ë°ì´í„°ë¥¼ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nìµœì‹  ë ˆì½”ë“œë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ëŠ” ì‚­ì œë©ë‹ˆë‹¤.')) {
            return;
        }

        showResult('clean-result', 'ì¤‘ë³µ ê²€ì‚¬ ì¤‘...', 'info');

        try {
            const response = await fetch('/admin/api/bulk/clean-duplicates', {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                showResult('clean-result', `âœ… ${data.message}`, 'success');
                setTimeout(() => loadDbStats(), 1000);
            } else {
                showResult('clean-result', `âŒ ${data.error}`, 'error');
            }
        } catch (error) {
            showResult('clean-result', `âŒ ì •ë¦¬ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    function showResult(containerId, message, type) {
        const container = document.getElementById(containerId);
        container.innerHTML = `<div class="result-box result-${type}">${message}</div>`;
    }

    // Database Stats
    async function loadDbStats() {
        try {
            const response = await fetch('/admin/api/stats');
            const data = await response.json();

            if (data.success) {
                renderDbStats(data.stats);
            }
        } catch (error) {
            console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    function renderDbStats(stats) {
        const container = document.getElementById('db-stats');

        const html = `
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="stat-item-label">ì „ì²´ ì•¨ë²”</div>
                    <div class="stat-item-value">${stats.total_albums.toLocaleString()}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">ì „ì²´ ë§í¬</div>
                    <div class="stat-item-value">${stats.total_links.toLocaleString()}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">ìˆ˜ì§‘ëœ ë§í¬</div>
                    <div class="stat-item-value">${stats.found_links.toLocaleString()}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">ìˆ˜ì§‘ ì™„ë£Œìœ¨</div>
                    <div class="stat-item-value">${stats.completion_rate}%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">ì»¤ë²„ ì´ë¯¸ì§€</div>
                    <div class="stat-item-value">${stats.albums_with_cover.toLocaleString()}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">ìµœê·¼ 7ì¼ ì—…ë°ì´íŠ¸</div>
                    <div class="stat-item-value">${stats.recent_updates.toLocaleString()}</div>
                </div>
            </div>
        `;

        container.innerHTML = html;
    }

    // ì´ˆê¸° ë¡œë“œ
    loadDbStats();
</script>
{% endblock %}
